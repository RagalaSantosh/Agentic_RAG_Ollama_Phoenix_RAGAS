# nb5-nginx.conf
server {
  listen 8080;
  server_name _;

  # allow big files
  client_max_body_size 200m;
  underscores_in_headers on;

  # ---------- Serve Open WebUI (container: open-webui:8080)
  location / {
    proxy_pass http://open-webui:8080;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ---------- Your FastAPI on the HOST (http://localhost:8000)

  # /v1/models
  location = /v1/models {
    proxy_pass http://host.docker.internal:8000/v1/models;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 120s;
    proxy_send_timeout 120s;
  }

  # /v1/chat/completions (SSE streaming)
  location = /v1/chat/completions {
    proxy_pass http://host.docker.internal:8000/v1/chat/completions;
    proxy_http_version 1.1;

    # Critical for SSE
    proxy_buffering off;
    proxy_request_buffering off;
    chunked_transfer_encoding off;
    add_header X-Accel-Buffering no;
    proxy_set_header Cache-Control no-cache;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ---------- Upload tool (multipart) — expose your existing endpoints

  # direct upload tool
  location = /tools/upload-docs/files {
    proxy_pass http://host.docker.internal:8000/tools/upload-docs/files;
    proxy_http_version 1.1;

    # multipart must not be buffered
    proxy_request_buffering off;
    proxy_buffering off;
    client_max_body_size 200m;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }
  location = /tools/upload-docs/files/ {
    proxy_pass http://host.docker.internal:8000/tools/upload-docs/files/;
    proxy_http_version 1.1;

    proxy_request_buffering off;
    proxy_buffering off;
    client_max_body_size 200m;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # Open WebUI paperclip endpoint → your upload tool
  location = /api/v1/files {
    proxy_pass http://host.docker.internal:8000/tools/upload-docs/files;
    proxy_http_version 1.1;

    proxy_request_buffering off;
    proxy_buffering off;
    client_max_body_size 200m;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }
  location = /api/v1/files/ {
    proxy_pass http://host.docker.internal:8000/tools/upload-docs/files/;
    proxy_http_version 1.1;

    proxy_request_buffering off;
    proxy_buffering off;
    client_max_body_size 200m;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ---------- (optional) keep your single-file helper for OWUI:
  # location = /tools/upload-docs/openwebui { proxy_pass http://host.docker.internal:8000/tools/upload-docs/openwebui; }

  # ---------- Logs
  access_log /var/log/nginx/access.log;
  error_log  /var/log/nginx/error.log info;
}
